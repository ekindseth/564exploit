import types

import cv2 as cv
import numpy as np


def message_to_bin(message):
    if type(message) == str:
        return ''.join([format(ord(i), "08b") for i in message])
    elif type(message) == bytes or type(message) == np.ndarray:
        return [format(i, "08b") for i in message]
    elif type(message) == int or type(message) == np.uint8:
        return format(message, "08b")
    else:
        raise TypeError("input not supported.")


def hide_data(image, message):
    n_bytes = image.shape[0] * image.shape[1] * 3 // 8

    if len(message) > n_bytes:
        print("error: need larger image or smaller message. Too many bytes to write")
        return 0

    message += "#####"

    data_index = 0

    binary_message = message_to_bin(message)
    message_len = len(binary_message)

    for values in image:
        for pixel in values:
            r, g, b = message_to_bin(pixel)

        if data_index < message_len:
            pixel[0] = int(r[:-1] + binary_message[data_index], 2)
            data_index += 1
        if data_index < message_len:
            pixel[1] = int(g[:-1] + binary_message[data_index], 2)
            data_index += 1
        if data_index < message_len:
            pixel[2] = int(b[:-1] + binary_message[data_index], 2)
            data_index += 1
        if data_index >= message_len:
            break
    return image


def decode_message(image):
    binary_data = ""
    for values in image:
        for pixel in values:
            r, g, b = message_to_bin(pixel)
            binary_data += r[-1]
            binary_data += g[-1]
            binary_data += b[-1]

    all_bytes = [binary_data[i: i + 8] for i in range(0, len(binary_data), 8)]
    decoded_data = ""
    for byte in all_bytes:
        decoded_data += chr(int(byte, 2))
        if decoded_data[-4:] == "#####":
            break

    return decoded_data[:-5]


image = cv.imread("idFace.jpg")
#image = cv.resize(image, (500, 500))
image = hide_data(image, "Tada")
cv.imwrite("idfacex.jpg", image)
imageOut = cv.imread("idfacex.jpg")
#imageOut = cv.resize(imageOut, (500, 500))
print(decode_message(imageOut))
