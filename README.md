# 564exploit

Evan and Stefans project

Hi, welcome to our 564 exploit. We decided to leverage an exploit in an enterprise messaging app called Inbit Messenger. It is vulnerable to a bufferoverflow that allowed for remote code execution.
Here is a link to the exploit on exploit-DB: https://www.exploit-db.com/exploits/51126

# Scenario

So, to set the scene, we decided to target a ski resort season pass holder database. In order to ski at many major resorts, there is an RFID gate system at each ski lift which allows
season pass holders to scan their RFID cards and then proceed to the lift. Our cyber effect can access the database of these season pass holders, and add and remove users.

# Initial setup

We wrote a wrapper script called master.py which calls the exploit script with our initial payload. The initial payload downloads the implant onto the victim computer and then runs it. Once the implant is downloaded and running, it will constantly be listening for TCP connections on port 12000. We can then connect to it by running our command and control (C2) python script with the target IP and port as parameter. Now that we are connected, the fun stuff begins.

# The Implant

The implant is the most interesting piece of code we wrote. It was written as a python script. However, we used two python libraries to compile it into an executable. The first was pyarmor, which obfuscates the script byte code. The second library was pyinstaller, which takes the obfuscated script and packs it into a windows exe. We had to make sure we compiled it with the correct flags so that it didn't spawn a windows command shell on runtime. The implant is also named "system_wifi_driver.exe" and installed into the windows folder in order to make it less conspicuous to a user. The implant functions in the following manner: it listens on port 12000 for TCP connections from the command and control. It receives commands from the command and control, and parses them and returns the result. However, it should be noted that we set a 20 second timeout on the socket so if a command is not sent every 20 seconds the socket will timeout in order to avoid detectance. The implant has a few abilities: it can execute any shell commands, it can add, remove, and view all data in the target user database, and it can delete itself. The implant is also persistent, it schedules itself using windows task scheduler to run as a task upon login to the target system. This prevents the implant from becoming unreachable if the target system ever gets shut off. When the implant needs to be removed, it creates a windows batch file that first waits a couple seconds for the implant to exit, and then deletes the implant, then deletes itself.

# The Command and Control

The command and control is relatively simple. It is run with the target ip and port as parameters:
Example usage: C2.py 192.294.29.2 3598
It can execute the follow commands
0 + arguments, where arguments is any windows powershell command
2: set path of current execution
3: destroy the implant
4 + argument. This command sleeps the implant for the amount of time specified in the argument
5: returns all user data from the user database
6: adds a user, takes three arguments, user id, name, and password
7: removes a user, takes one argument, the user id to remove
9: exit: exits the c2

# Obfuscation Methods

So we obfuscated three things in this project: the implant itself, the communication from implant to C2, and the communication from C2 to implant.
We obfuscated the implant by compiling it into an exe with pyarmor and pyinstaller, which obfuscates the bytecode and the strings inside the file so we that when something like "strings" is called on the exe it doesn't print anything legible. We also installed the implant into a folder called logs2 inside the windows folder on the target machine, and named the exe "system_wifi_driver.exe" to make it a little less conspicuous. We obfuscated the communication from the implant to the C2 by using imagine steganography. We hid the bytes of the exfil data in the least significant bytes of the pixels of an image using a python library called stegano. As for the obfuscation from the c2 to the implant, we obfuscated the c2 commands by storing them in the metadata of an image and sending this over a tcp socket.
